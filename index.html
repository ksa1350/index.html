<!-- 
ูุนูููุงุช ุงูุฏุฎูู ููุฃุฏูู:
1. ุฑูู ุงูุฅูุงูุฉ: admin ุฃู 6500
2. ูููุฉ ุงููุฑูุฑ: 1234

ููุงุญุธุฉ: ูุฐู ุงููุนูููุงุช ูุถุจูุทุฉ ุชููุงุฆูุงู ุนูุฏ ุชุดุบูู ุงููุธุงู ูุฃูู ูุฑุฉ
-->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="ูุธุงู ุฅุฏุงุฑุฉ ุงูุญุถูุฑ ูุงูุบูุงุจ - ูุฏุฑุณุฉ ุนูุงุฏ ุงูุฏูู ุฒููู">
<title>ูุธุงู ูุฏุฑุณุฉ ุนูุงุฏ ุงูุฏูู ุฒููู</title>
<style>
body { font-family:"Tahoma",sans-serif; background:#e6f2ff; margin:0; padding:0; }
header { background:#1f3f68; color:#fff; padding:20px; font-size:26px; text-align:center; }
.container { margin:30px auto; padding:25px; max-width:750px; background:#fff; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.2);} 
input, select, button { width:95%; padding:12px; margin:8px 0; border-radius:8px; border:1px solid #ccc; font-size:16px; transition:0.3s; }
input:focus, select:focus { border-color:#3498db; box-shadow:0 0 8px rgba(52,152,219,0.5); outline:none; }
button { background:#3498db; color:#fffbfb; cursor:pointer; border:none; font-weight:bold; }
button:hover { background:#2980b9; transform:scale(1.05); box-shadow:0 0 10px rgba(0,0,0,0.3); }
button:active { transform:scale(0.98); }
label { font-size:14px; }
.hidden { display:none; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
table, th, td { border:1px solid #ccc; }
th, td { padding:8px; text-align:center; }
.tip { font-size:12px; color:#555; margin-top:-6px; }

@media (max-width: 768px) {
  .container { margin:10px; padding:15px; }
  input, select, button { width:100%; }
  table { font-size:14px; }
}
</style>
</head>
<body>
<header>ูุฏุฑุณุฉ ุนูุงุฏ ุงูุฏูู ุฒููู</header>

<!-- ุชุณุฌูู ุงูุฏุฎูู -->
<div id="loginPage" class="container">
  <h2 style="text-align:center; color:#1e3a5f;">ุชุณุฌูู ุงูุฏุฎูู</h2>
  <input type="text" id="loginId" placeholder="ุฑูู ุงูุฅูุงูุฉ">
  <input type="password" id="loginPassword" placeholder="ูููุฉ ุงููุฑูุฑ">
  <label><input type="checkbox" id="rememberMe"> ุชุฐูุฑูู</label>
  <button id="loginBtn">ุฏุฎูู</button>
</div>

<!-- ุงุฎุชูุงุฑ ููุญุฉ ุงูุชุญูู (ููุฃุฏูู ููุท) -->
<div id="adminChoice" class="container hidden">
  <h2 style="text-align:center; color:#1e3a5f;">ุงุฎุชุฑ ููุญุฉ ุงูุชุญูู</h2>
  <button id="toAdmin">ููุญุฉ ุงูุฃุฏูู</button>
  <button id="toTeacher">ููุญุฉ ุงููุฏุฑุณ</button>
  <button id="toStudent">ููุญุฉ ุงูุทุงูุจ</button>
  <button style="background:#e74c3c;" onclick="logout()">ุชุณุฌูู ุฎุฑูุฌ</button>
</div>

<!-- ููุญุฉ ุงูุฃุฏูู -->
<div id="adminPage" class="container hidden">
  <h2>ููุญุฉ ุงูุฃุฏูู</h2>
  <button onclick="showSection('addTeacher')">โ ุฅุถุงูุฉ ูุฏุฑุณ</button>
  <button onclick="showSection('addStudent')">โ ุฅุถุงูุฉ ุทุงูุจ</button>
  <button onclick="showSection('importExcel')">๐ ุงุณุชูุฑุงุฏ ุทูุงุจ ูู ุฅูุณู</button>
  <button onclick="showSection('report')">๐ ุงูุชูุฑูุฑ</button>
  <button onclick="showSection('manage')">โ๏ธ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</button>
  <button onclick="deleteAllStudents()" style="background:#e74c3c">๐๏ธ ุญุฐู ุฌููุน ุงูุทูุงุจ</button>
  <button style="background:#e74c3c;" onclick="logout()">ุชุณุฌูู ุฎุฑูุฌ</button>

  <!-- ุฅุถุงูุฉ ูุฏุฑุณ -->
  <div id="addTeacher" class="hidden">
    <h3>ุฅุถุงูุฉ ูุฏุฑุณ</h3>
    <input type="text" id="teacherName" placeholder="ุงุณู ุงููุฏุฑุณ">
    <input type="text" id="teacherId" placeholder="ุฑูู ุงูุฅูุงูุฉ">
    <input type="password" id="teacherPassword" placeholder="ูููุฉ ุงููุฑูุฑ">
    <label><input type="checkbox" id="isAdmin"> ุฃุฏููุ</label>
    <button onclick="addTeacher()">ุญูุธ</button>
  </div>

  <!-- ุฅุถุงูุฉ ุทุงูุจ -->
  <div id="addStudent" class="hidden">
    <h3>ุฅุถุงูุฉ ุทุงูุจ</h3>
    <input type="text" id="studentName" placeholder="ุงุณู ุงูุทุงูุจ">
    <input type="text" id="studentId" placeholder="ุฑูู ุงูุฅูุงูุฉ">
    <input type="password" id="studentPassword" placeholder="ูููุฉ ุงููุฑูุฑ">
    <select id="grade">
      <option>ุฃูู ูุชูุณุท</option><option>ุซุงูู ูุชูุณุท</option><option>ุซุงูุซ ูุชูุณุท</option>
    </select>
    <select id="class">
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
    </select>
    <button onclick="addStudent()">ุญูุธ</button>
  </div>

  <!-- ุงุณุชูุฑุงุฏ ุทูุงุจ ูู ุฅูุณู -->
  <div id="importExcel" class="hidden">
    <h3>๐ ุงุณุชูุฑุงุฏ ุทูุงุจ ูู ููู ุฅูุณู</h3>
    <div class="tip">A = ุงููุตูุ C = ุงูุงุณูุ D = ุงููููุฉ</div>
    <label>ุงุฎุชุฑ ุงููุฑุญูุฉ</label>
    <select id="importGrade">
      <option value="">โ ุงุฎุชุฑ โ</option>
      <option>ุฃูู ูุชูุณุท</option><option>ุซุงูู ูุชูุณุท</option><option>ุซุงูุซ ูุชูุณุท</option>
    </select>
    <input type="file" id="excelFile" accept=".xls,.xlsx">
    <button onclick="importExcel()">ุฑูุน ูุฅุถุงูุฉ</button>
  </div>

  <!-- ุงูุชูุฑูุฑ -->
  <div id="report" class="hidden">
    <h3>ุงูุชูุฑูุฑ</h3>
    <input type="text" id="filterStudent" placeholder="ุงุณู ุงูุทุงูุจ ุฃู ุฑูู ุงูุฅูุงูุฉ">
    <label>ูู ุชุงุฑูุฎ:</label>
    <input type="date" id="filterFromDate">
    <label>ุฅูู ุชุงุฑูุฎ:</label>
    <input type="date" id="filterToDate">
    <select id="filterGrade"><option value="">ุงุฎุชุฑ ุงููุฑุญูุฉ</option><option>ุฃูู ูุชูุณุท</option><option>ุซุงูู ูุชูุณุท</option><option>ุซุงูุซ ูุชูุณุท</option></select>
    <select id="filterClass"><option value="">ุงุฎุชุฑ ุงููุตู</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select>
    <select id="filterSession"><option value="">ุงุฎุชุฑ ุงูุญุตุฉ</option><option>ุงูุฃููู</option><option>ุงูุซุงููุฉ</option><option>ุงูุซุงูุซุฉ</option><option>ุงูุฑุงุจุนุฉ</option><option>ุงูุฎุงูุณุฉ</option><option>ุงูุณุงุฏุณุฉ</option><option>ุงูุณุงุจุนุฉ</option></select>
    <button onclick="showReport()">ุนุฑุถ</button>
    <button onclick="downloadCSV()">ุชุญููู CSV</button>
    <div id="reportTable"></div>
    <div id="reportStats" style="font-weight:bold; margin-top:10px;"></div>
  </div>

  <!-- ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู -->
  <div id="manage" class="hidden">
    <h3>ุฅุฏุงุฑุฉ ุงูุทูุงุจ ูุงููุฏุฑุณูู</h3>
    <input type="text" id="searchId" placeholder="ุงุจุญุซ ุจุฑูู ุงูุฅูุงูุฉ">
    <button onclick="searchUser()">ุจุญุซ</button>
    <div id="searchResult"></div>
  </div>
</div>

<!-- ููุญุฉ ุงููุฏุฑุณ -->
<div id="teacherPage" class="container hidden">
  <h2>ููุญุฉ ุงููุฏุฑุณ</h2>
  <label>ุงุฎุชุฑ ุงููุฑุญูุฉ</label>
  <select id="teacherGrade">
    <option value="">ุงุฎุชุฑ ุงููุฑุญูุฉ</option>
    <option>ุฃูู ูุชูุณุท</option><option>ุซุงูู ูุชูุณุท</option><option>ุซุงูุซ ูุชูุณุท</option>
  </select>
  <label>ุงุฎุชุฑ ุงููุตู</label>
  <select id="teacherClass">
    <option value="">ุงุฎุชุฑ ุงููุตู</option>
    <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
    <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
  </select>
  <label>ุงุฎุชุฑ ุงูุญุตุฉ</label>
  <select id="sessionSelect">
    <option>ุงูุฃููู</option><option>ุงูุซุงููุฉ</option><option>ุงูุซุงูุซุฉ</option>
    <option>ุงูุฑุงุจุนุฉ</option><option>ุงูุฎุงูุณุฉ</option><option>ุงูุณุงุฏุณุฉ</option><option>ุงูุณุงุจุนุฉ</option>
  </select>
  <button onclick="loadStudents()">ุนุฑุถ ุงูุทูุงุจ</button>
  <div id="studentList">ุงุฎุชุฑ ุงููุฑุญูุฉ ูุงููุตู ุซู ุงุถุบุท ุนุฑุถ ุงูุทูุงุจ.</div>
  <button style="background:#e74c3c;" onclick="logout()">ุชุณุฌูู ุฎุฑูุฌ</button>
</div>

<!-- ููุญุฉ ุงูุทุงูุจ -->
<div id="studentPage" class="container hidden">
  <h2>ููุญุฉ ุงูุทุงูุจ</h2>
  <label>ุงุฎุชุฑ ููู</label>
  <input type="date" id="studentDay">
  <button onclick="showStudentDay()">ุนุฑุถ</button>
  <hr>
  <label>ูู ุชุงุฑูุฎ</label>
  <input type="date" id="fromDate">
  <label>ุฅูู ุชุงุฑูุฎ</label>
  <button onclick="showStudentRange()">ุนุฑุถ ุงููุชุฑุฉ</button>
  <div id="studentReport"></div>
  <button style="background:#e74c3c;" onclick="logout()">ุชุณุฌูู ุฎุฑูุฌ</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ================== ุจูุงูุงุช ==================
let users = JSON.parse(localStorage.getItem("users")) || [];
let students = JSON.parse(localStorage.getItem("students")) || [];
let attendance = JSON.parse(localStorage.getItem("attendance")) || [];

// ุงูุฃุฏูู ุงูุงูุชุฑุงุถู
(function ensureAdmins(){
  if(!users.find(u=>u.id==="admin" && u.isAdmin))
    users.push({id:"admin", name:"ุงููุฏูุฑ", password:"1234", isAdmin:true});
  if(!users.find(u=>u.id==="6500" && u.isAdmin))
    users.push({id:"6500", name:"ุงููุฏูุฑ", password:"1234", isAdmin:true});
  localStorage.setItem("users", JSON.stringify(users));
})();

let currentUser = JSON.parse(localStorage.getItem("currentUser"));
window.onload = function(){
  if(currentUser){
    if(currentUser.isAdmin) showPage("adminChoice");
    else if(currentUser.isTeacher) showTeacherPage();
    else if(currentUser.isStudent) showStudentPage();
  }
}

document.getElementById('loginBtn').addEventListener('click', login);
['loginId','loginPassword'].forEach(id=>{
  document.getElementById(id).addEventListener('keyup', e=>{ if(e.key==='Enter') login(); });
});

document.getElementById('toAdmin').addEventListener('click',()=>showPage('adminPage'));
document.getElementById('toTeacher').addEventListener('click',showTeacherPage);
document.getElementById('toStudent').addEventListener('click',showStudentPage);

['teacherGrade','teacherClass'].forEach(id=>{
  document.getElementById(id).addEventListener('change', loadStudents);
});

// ============= ุชุณุฌูู ุงูุฏุฎูู =============
function login(){
  const id=document.getElementById("loginId").value.trim();
  const pass=document.getElementById("loginPassword").value.trim();
  const remember=document.getElementById("rememberMe").checked;
  const user=users.find(u=>u.id===id && u.password===pass);
  if(!user){ alert("ุงูุจูุงูุงุช ุฎุงุทุฆุฉ"); return; }
  currentUser=user;
  if(remember) localStorage.setItem("currentUser", JSON.stringify(user));
  else localStorage.removeItem("currentUser");
  if(user.isAdmin) showPage("adminChoice");
  else if(user.isTeacher) showTeacherPage();
  else if(user.isStudent) showStudentPage();
}

function logout(){ currentUser=null; localStorage.removeItem("currentUser"); showPage("loginPage"); }
function showPage(pageId){
  ["loginPage","adminPage","teacherPage","adminChoice","studentPage"].forEach(id=>document.getElementById(id).classList.add("hidden"));
  document.getElementById(pageId).classList.remove("hidden");
}
function showTeacherPage(){ showPage('teacherPage'); }
function showStudentPage(){ showPage('studentPage'); }

function showSection(sectionId){
  ["addTeacher","addStudent","report","manage","importExcel"].forEach(id=>document.getElementById(id).classList.add("hidden"));
  document.getElementById(sectionId).classList.remove("hidden");
}

// ============= ุฅุถุงูุฉ ูุฏุฑุณ =============
function addTeacher(){
  const name=document.getElementById("teacherName").value.trim();
  const id=document.getElementById("teacherId").value.trim();
  const pass=document.getElementById("teacherPassword").value.trim();
  const isAdmin=document.getElementById("isAdmin").checked;
  if(!name||!id||!pass){alert("ุงููุฃ ุฌููุน ุงูุญููู");return;}
  if(users.find(u=>u.id===id)){alert("ุงููุนูู ููุฌูุฏ"); return;}
  users.push({id,name,password:pass,isAdmin,isTeacher:true});
  localStorage.setItem("users",JSON.stringify(users));
  alert("ุชูุช ุฅุถุงูุฉ ุงููุฏุฑุณ");
}

// ============= ุฅุถุงูุฉ ุทุงูุจ =============
function addStudent(){
  const name=document.getElementById("studentName").value.trim();
  const id=document.getElementById("studentId").value.trim();
  const pass=document.getElementById("studentPassword").value.trim();
  const grade=document.getElementById("grade").value;
  const cls=document.getElementById("class").value;
  if(!name||!id||!pass){alert("ุงููุฃ ุฌููุน ุงูุญููู");return;}
  if(students.find(s=>s.id===id)){alert("ุงูุทุงูุจ ููุฌูุฏ");return;}
  students.push({id,name,grade,class:cls});
  users.push({id,name,password:pass,isStudent:true});
  localStorage.setItem("students",JSON.stringify(students));
  localStorage.setItem("users",JSON.stringify(users));
  alert("ุชูุช ุฅุถุงูุฉ ุงูุทุงูุจ");
}

// ============= ุงุณุชูุฑุงุฏ ูู ุงูุณู =============
function importExcel(){
  const file=document.getElementById("excelFile").files[0];
  const chosenGrade=document.getElementById("importGrade").value;
  if(!file){alert("ุงุฎุชุฑ ููู ุฅูุณู"); return;}
  const reader=new FileReader();
  reader.onload=function(e){
    const data=new Uint8Array(e.target.result);
    const workbook=XLSX.read(data,{type:'array'});
    const sheet=workbook.Sheets[workbook.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sheet,{header:1});
    let added=0;
    for(let i=1;i<rows.length;i++){
      const r=rows[i];
      const cls=r[0];
      const name=r[2];
      const id=r[3];
      if(!name||!id) continue;
      let grade=chosenGrade||"";
      if(!students.find(s=>s.id==id)){
        students.push({id,name,grade,class:cls});
        users.push({id,name,password:"1234",isStudent:true});
        added++;
      }
    }
    localStorage.setItem("students",JSON.stringify(students));
    localStorage.setItem("users",JSON.stringify(users));
    alert("ุชู ุงุณุชูุฑุงุฏ "+added+" ุทุงูุจ");
  };
  reader.readAsArrayBuffer(file);
}

// ============= ุชุญููู ุงูุทูุงุจ ูููุฏุฑุณ =============
function loadStudents(){
  const grade=document.getElementById("teacherGrade").value;
  const cls=document.getElementById("teacherClass").value;
  let list=document.getElementById("studentList");
  list.innerHTML="";
  let filtered=students.filter(s=>(!grade||s.grade===grade)&&(!cls||s.class===cls));
  if(filtered.length===0){list.innerHTML="ูุง ููุฌุฏ ุทูุงุจ."; return;}
  filtered.forEach(s=>{
    let div=document.createElement("div");
    div.innerHTML=`${s.name} (${s.id}) - ${s.grade} ูุตู ${s.class} 
    <button onclick="markAttendance('${s.id}','ุญุงุถุฑ')">โ</button> 
    <button onclick="markAttendance('${s.id}','ูุชุฃุฎุฑ')">โฐ</button> 
    <button onclick="markAttendance('${s.id}','ุบุงุฆุจ')">โ</button>`;
    list.appendChild(div);
  });
}

// ============= ุชุณุฌูู ุงูุญุถูุฑ =============
function markAttendance(studentId,status){
  const session=document.getElementById("sessionSelect").value;
  const now=new Date().toISOString().split('T')[0];
  attendance.push({studentId,status,session,teacher:currentUser.name,date:now});
  localStorage.setItem("attendance",JSON.stringify(attendance));
  alert("ุชู ุงูุญูุธ");
}

// ============= ูุงุฌูุฉ ุงูุทุงูุจ =============
function showStudentDay(){
  const day=document.getElementById("studentDay").value;
  const data=attendance.filter(a=>a.studentId===currentUser.id && a.date===day);
  displayStudentReport(data);
}
function showStudentRange(){
  const from=document.getElementById("fromDate").value;
  const to=document.getElementById("toDate").value;
  const data=attendance.filter(a=>a.studentId===currentUser.id && (!from||a.date>=from)&&(!to||a.date<=to));
  displayStudentReport(data);
}
function displayStudentReport(data){
  let div=document.getElementById("studentReport");
  if(data.length===0){div.innerHTML="ูุง ุชูุฌุฏ ุณุฌูุงุช"; return;}
  let table="<table><tr><th>ุงูุญุงูุฉ</th><th>ุงูุญุตุฉ</th><th>ุงููุฏุฑุณ</th><th>ุงูุชุงุฑูุฎ</th></tr>";
  data.forEach(a=>{ table+=`<tr><td>${a.status}</td><td>${a.session}</td><td>${a.teacher}</td><td>${a.date}</td></tr>`; });
  table+="</table>";
  div.innerHTML=table;
}

// ============= ุงูุชูุฑูุฑ =============
function showReport(){
  const grade = document.getElementById("filterGrade").value;
  const cls = document.getElementById("filterClass").value;
  const session = document.getElementById("filterSession").value;
  const studentSearch = document.getElementById("filterStudent").value.trim().toLowerCase();
  const fromDate = document.getElementById("filterFromDate").value;
  const toDate = document.getElementById("filterToDate").value;
  
  let data = attendance;
  
  // ููุชุฑุฉ ุญุณุจ ุงูุชุงุฑูุฎ
  if(fromDate || toDate) {
    data = data.filter(a => 
      (!fromDate || a.date >= fromDate) && 
      (!toDate || a.date <= toDate)
    );
  }

  // ููุชุฑุฉ ุญุณุจ ุงููุฑุญูุฉ ูุงููุตู ูุงูุทุงูุจ
  if(grade || cls || studentSearch) {
    const filtered = students.filter(s => 
      (!grade || s.grade === grade) && 
      (!cls || s.class === cls) &&
      (!studentSearch || 
        s.name.toLowerCase().includes(studentSearch) || 
        s.id.toLowerCase().includes(studentSearch))
    ).map(s => s.id);
    data = data.filter(a => filtered.includes(a.studentId));
  }
  
  if(session) data = data.filter(a => a.session === session);

  let table = "<table><tr><th>ุงูุงุณู</th><th>ุงููููุฉ</th><th>ุงููุฑุญูุฉ</th><th>ุงููุตู</th><th>ุงูุญุงูุฉ</th><th>ุงูุญุตุฉ</th><th>ุงููุฏุฑุณ</th><th>ุงูุชุงุฑูุฎ</th></tr>";
  data.forEach(a => {
    const student = students.find(s => s.id === a.studentId);
    if(student) {
      table += `<tr>
        <td>${student.name}</td>
        <td>${student.id}</td>
        <td>${student.grade}</td>
        <td>${student.class}</td>
        <td>${a.status}</td>
        <td>${a.session}</td>
        <td>${a.teacher}</td>
        <td>${a.date}</td>
      </tr>`;
    }
  });
  table += "</table>";
  
  document.getElementById("reportTable").innerHTML = data.length ? table : "ูุง ุชูุฌุฏ ุณุฌูุงุช";
  
  // ุฅุญุตุงุฆูุงุช
  const stats = {ุญุงุถุฑ: 0, ูุชุฃุฎุฑ: 0, ุบุงุฆุจ: 0};
  data.forEach(a => stats[a.status]++);
  document.getElementById("reportStats").innerHTML = 
    `ุงูุฅุฌูุงูู: ุญุถูุฑ (${stats.ุญุงุถุฑ})ุ ุชุฃุฎุฑ (${stats.ูุชุฃุฎุฑ})ุ ุบูุงุจ (${stats.ุบุงุฆุจ})`;
}

function downloadCSV() {
  const grade = document.getElementById("filterGrade").value;
  const cls = document.getElementById("filterClass").value;
  const session = document.getElementById("filterSession").value;
  const fromDate = document.getElementById("filterFromDate").value;
  const toDate = document.getElementById("filterToDate").value;
  
  let data = attendance;
  if(fromDate || toDate) {
    data = data.filter(a => 
      (!fromDate || a.date >= fromDate) && 
      (!toDate || a.date <= toDate)
    );
  }
  if(grade || cls) {
    const filtered = students.filter(s => 
      (!grade || s.grade === grade) && 
      (!cls || s.class === cls)
    ).map(s => s.id);
    data = data.filter(a => filtered.includes(a.studentId));
  }
  if(session) data = data.filter(a => a.session === session);

  let csv = "ุงูุงุณู,ุงููููุฉ,ุงููุฑุญูุฉ,ุงููุตู,ุงูุญุงูุฉ,ุงูุญุตุฉ,ุงููุฏุฑุณ,ุงูุชุงุฑูุฎ\n";
  data.forEach(a => {
    const student = students.find(s => s.id === a.studentId);
    if(student) {
      csv += `${student.name},${student.id},${student.grade},${student.class},${a.status},${a.session},${a.teacher},${a.date}\n`;
    }
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "ุชูุฑูุฑ.csv";
  link.click();
}

function searchUser() {
  const id = document.getElementById("searchId").value.trim();
  const result = document.getElementById("searchResult");
  
  const user = users.find(u => u.id === id);
  if(!user) {
    result.innerHTML = "ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุณุชุฎุฏู";
    return;
  }

  const student = students.find(s => s.id === id);
  let html = `<div>
    ุงูุงุณู: ${user.name}<br>
    ุงููููุฉ: ${user.id}<br>
    ุงูููุน: ${user.isAdmin ? 'ุฃุฏูู' : user.isTeacher ? 'ูุฏุฑุณ' : 'ุทุงูุจ'}<br>`;
  
  if(student) {
    html += `ุงููุฑุญูุฉ: ${student.grade}<br>
    ุงููุตู: ${student.class}<br>`;
  }
  
  html += `<input type="password" id="newPass_${id}" placeholder="ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ">
    <button onclick="changePassword('${id}')">ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</button>
    <button onclick="deleteUser('${id}')" style="background:#e74c3c">ุญุฐู</button>
    </div>`;
    
  result.innerHTML = html;
}

function changePassword(id) {
  const newPass = document.getElementById(`newPass_${id}`).value.trim();
  if(!newPass) {
    alert("ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ");
    return;
  }
  const user = users.find(u => u.id === id);
  if(user) {
    user.password = newPass;
    localStorage.setItem("users", JSON.stringify(users));
    alert("ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ");
  }
}

function deleteUser(id) {
  if(!confirm("ูุชุฃูุฏ ูู ุงูุญุฐูุ")) return;
  
  users = users.filter(u => u.id !== id);
  students = students.filter(s => s.id !== id);
  attendance = attendance.filter(a => a.studentId !== id);
  
  localStorage.setItem("users", JSON.stringify(users));
  localStorage.setItem("students", JSON.stringify(students));
  localStorage.setItem("attendance", JSON.stringify(attendance));
  
  searchUser();
}

function deleteAllStudents() {
  if(!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูุทูุงุจุ\nูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐู ุงูุนูููุฉ!")) return;
  if(!confirm("ุชุฃููุฏ ูุฑุฉ ุฃุฎุฑู: ุณูุชู ุญุฐู ุฌููุน ุงูุทูุงุจ ูุจูุงูุงุชูู ูุณุฌูุงุช ุญุถูุฑูู")) return;
  
  // ุญุฐู ุฌููุน ุงูุทูุงุจ ูุจูุงูุงุชูู
  const studentIds = students.map(s => s.id);
  users = users.filter(u => !u.isStudent);
  students = [];
  attendance = attendance.filter(a => !studentIds.includes(a.studentId));
  
  // ุญูุธ ุงูุชุบููุฑุงุช
  localStorage.setItem("users", JSON.stringify(users));
  localStorage.setItem("students", JSON.stringify(students));
  localStorage.setItem("attendance", JSON.stringify(attendance));
  
  alert("ุชู ุญุฐู ุฌููุน ุงูุทูุงุจ ูุจูุงูุงุชูู");
}
</script>
</body>
</html>